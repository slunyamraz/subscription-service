name: Go CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Получаем код
      - name: Checkout code
        uses: actions/checkout@v3

      # Шаг 2: Показываем где мы и что есть
      - name: Show environment
        run: |
          echo "=== Working directory ==="
          pwd
          echo ""
          echo "=== All files and folders ==="
          ls -la
          echo ""
          echo "=== Go files structure ==="
          find . -name "*.go" -type f | head -30
          echo ""
          echo "=== Looking for go.mod ==="
          find . -name "go.mod" -type f
          echo ""
          echo "=== Content of go.mod ==="
          cat ./go.mod 2>/dev/null || echo "WARNING: go.mod not found!"

      # Шаг 3: Настраиваем Go
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # Шаг 4: Проверяем Go
      - name: Check Go
        run: |
          echo "=== Go version ==="
          go version
          echo ""
          echo "=== Go environment ==="
          go env

      # Шаг 5: Пробуем собрать
      - name: Build attempt
        run: |
          echo "=== Trying to build ==="
          
          # Сначала ищем где main
          echo "1. Looking for main packages..."
          find . -name "main.go" -type f | while read file; do
            echo "Found main.go at: $file"
            dir=$(dirname "$file")
            echo "  Directory: $dir"
          done
          
          echo ""
          echo "2. Trying to build from root..."
          if [ -f "go.mod" ]; then
            echo "go.mod exists, building..."
            go build ./...
            echo "✅ Build command executed"
          else
            echo "❌ go.mod not found in current directory!"
          fi